{"version":3,"file":"modelz.js","sources":["src/util.js","src/index.js"],"sourcesContent":["'use strict'\n\nexport function noop() {}\n\nexport function identity(thing) {\n  return thing\n}\n\nexport function type(obj) {\n  return {}.toString.call(obj)\n}\n\nexport function isObject(thing) {\n  return thing !== null && type(thing) === '[object Object]'\n}\n\nexport function isArray(thing) {\n  return type(thing) == '[object Array]'\n}\n\nexport function isFunction(thing) {\n  return typeof thing === 'function'\n}\n\nexport function isString(thing) {\n  return typeof thing === 'string'\n}\n\nexport function isNumber(thing) {\n  return typeof thing === 'number'\n}\n\nexport function isUndefined(thing) {\n  return typeof thing === 'undefined'\n}\n","'use strict'\n\nimport {\n  identity,\n  isArray,\n  isFunction,\n  isNumber,\n  isObject,\n  isString,\n  noop,\n} from './util'\n\nconst defaultFieldConfig = {\n  construct: identity,\n  getCacheKey: noop,\n  enumerable: true,\n  required: false,\n}\n\nconst defaultGlobalConfig = {\n  castString: true,\n  parseNumbers: true,\n  onChangeListener: function() {\n    return noop\n  },\n  extraProperties: false,\n  embedPlainData: true,\n  preInit: identity,\n  postInit: identity,\n  types: {},\n}\n\nfunction createCacheFunction(depProps) {\n  return function(obj) {\n    return depProps.map(prop => obj[prop]).join('|<3|')\n  }\n}\n\nfunction modelz(globalConfig) {\n  globalConfig = Object.assign({}, defaultGlobalConfig, globalConfig)\n  function getConstructor(item, fieldname) {\n    const constructors = Object.assign(\n      {\n        string(value) {\n          if (isString(value)) {\n            return value\n          }\n          if (globalConfig.castString) {\n            return '' + value\n          }\n          throw Error(`Expect a string for \"${fieldname}\", got \"${value}\"`)\n        },\n        number(value) {\n          if (isNumber(value)) {\n            return value\n          }\n          if (isString(value) && globalConfig.parseNumbers) {\n            return parseFloat(value)\n          }\n          throw Error(`Expect a number for \"${fieldname}\", got \"${value}\"`)\n        },\n        boolean(value) {\n          return !!value\n        },\n        array(value) {\n          return [].concat(value)\n        },\n        object(value) {\n          return Object.assign({}, value)\n        },\n        date(value) {\n          return new Date(value)\n        },\n        identity,\n      },\n      globalConfig.types\n    )\n\n    if (isFunction(item)) {\n      return item\n    }\n    if (constructors[item] == null) {\n      throw Error(\n        `Try to use unknown type \"${item}\" as type for \"${fieldname}\"`\n      )\n    }\n    return constructors[item]\n  }\n  function parseConfig(fieldConfig, fieldname) {\n    if (isObject(fieldConfig)) {\n      if (isFunction(fieldConfig.construct)) {\n        // constructor\n        return fieldConfig\n      }\n\n      if (isString(fieldConfig.type)) {\n        // type\n        return Object.assign(\n          {\n            construct: getConstructor(fieldConfig.type, fieldname),\n          },\n          fieldConfig\n        )\n      }\n\n      if (\n        isArray(fieldConfig.get) &&\n        isFunction(fieldConfig.get[0]) &&\n        (isFunction(fieldConfig.get[1]) || isArray(fieldConfig.get[1]))\n      ) {\n        // computed property with cache function\n        return {\n          getCacheKey: isArray(fieldConfig.get[1])\n            ? createCacheFunction(fieldConfig.get[1])\n            : fieldConfig.get[1],\n          get: fieldConfig.get[0],\n          set: fieldConfig.set,\n        }\n      }\n\n      if (isFunction(fieldConfig.get)) {\n        // computed property\n        return {\n          getCacheKey: noop,\n          get: fieldConfig.get,\n          set: fieldConfig.set,\n        }\n      }\n    }\n\n    if (isArray(fieldConfig) && fieldConfig.length === 2) {\n      // short syntax without default [type, required]\n      const [type, required] = fieldConfig\n      return {\n        construct: getConstructor(type, fieldname),\n        required,\n      }\n    }\n\n    if (isArray(fieldConfig) && fieldConfig.length === 3) {\n      // short syntax [type, required, default]\n      const [type, required, defaultValue] = fieldConfig\n      return {\n        construct: getConstructor(type, fieldname),\n        required,\n        default: defaultValue,\n      }\n    }\n\n    if (isFunction(fieldConfig)) {\n      // plain construct\n      return {\n        construct: fieldConfig,\n      }\n    }\n\n    if (isString(fieldConfig)) {\n      try {\n        // init by type\n        return {\n          construct: getConstructor(fieldConfig, fieldname),\n        }\n      } catch (e) {\n        // fail silently and try next init\n      }\n    }\n\n    try {\n      // init by default\n      return {\n        construct: getConstructor(typeof fieldConfig, fieldname),\n        required: true,\n        default: fieldConfig,\n      }\n    } catch (e) {\n      throw new Error(\n        `No proper config handler found for config:\\n${JSON.stringify(\n          fieldConfig\n        )}`\n      )\n    }\n  }\n\n  return function Schema(fields, config) {\n    config = Object.assign({}, globalConfig, config)\n    return function construct(data = {}) {\n      const _data = {}\n      let onChange = noop\n\n      let result = {}\n      if (config.extraProperties) {\n        result = Object.assign({}, data)\n      }\n\n      if (config.embedPlainData) {\n        Object.defineProperty(result, '_data', {\n          get: () => _data,\n          enumerable: false,\n        })\n      }\n      result = config.preInit(result)\n      onChange = config.onChangeListener(result)\n      for (const fieldname in fields) {\n        if (!fields.hasOwnProperty(fieldname)) {\n          continue\n        }\n        const fieldConfig = Object.assign(\n          {},\n          defaultFieldConfig,\n          parseConfig(fields[fieldname], fieldname)\n        )\n        if (data.hasOwnProperty(fieldname)) {\n          if (data[fieldname] == null) {\n            _data[fieldname] = data[fieldname]\n          } else {\n            _data[fieldname] = fieldConfig.construct(data[fieldname], result)\n          }\n        } else if (fieldConfig.default === null) {\n          _data[fieldname] = fieldConfig.default\n        } else if (fieldConfig.hasOwnProperty('default')) {\n          _data[fieldname] = fieldConfig.construct(fieldConfig.default, result)\n        } else if (fieldConfig.required) {\n          throw Error(`No value set for ${fieldname}`)\n        }\n        Object.defineProperty(result, fieldname, {\n          enumerable: !isFunction(fieldConfig.get) && fieldConfig.enumerable,\n          get: function() {\n            if (fieldConfig.get) {\n              const key = fieldConfig.getCacheKey(result)\n              if (\n                !_data.hasOwnProperty(fieldname) ||\n                key == null ||\n                key !== _data[fieldname].key\n              ) {\n                _data[fieldname] = {\n                  key,\n                  value: fieldConfig.get(result),\n                }\n              }\n              return _data[fieldname].value\n            }\n            return result._data[fieldname]\n          },\n          set: function(value) {\n            const oldValue = result[fieldname]\n            if (isFunction(fieldConfig.set)) {\n              fieldConfig.set(result, value)\n            } else {\n              _data[fieldname] = value\n            }\n            onChange(fieldname, value, oldValue)\n          },\n        })\n      }\n      result = config.postInit(result)\n      if (!globalConfig.extraProperties) {\n        Object.seal(result)\n      }\n      return result\n    }\n  }\n}\n\nexport default modelz\n"],"names":["const","type","required","let"],"mappings":"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"}